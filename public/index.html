<!doctype html>

<html ng-app="scotchTodo">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Node/Angular Todo App</title>

	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
	<style>
		html {
			overflow-y: scroll;
		}
		body {
			padding-top: 50px;
		}
		#todo-list {
			margin-bottom: 30px;
		}
		#container {
			position: relative;
			width: 100%;
			height: 600px;
		}
	</style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
	
	<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
	<script src="/bower_components/datamaps/dist/datamaps.all.hires.min.js"></script>
	<script src="core.js"></script>
</head>

<body ng-controller="mainController">
	<div class="row">
		<div class="col-sm-4 col-sm-offset-2">
			<a href="#" id="nam" class="btn btn-primary">NAM</a>
			<a href="#" id="gfs" class="btn btn-primary">GFS</a>
		</div>
		<div class="col-sm-4">
			<a href="#" id="world" class="btn btn-primary">World</a>
			<a href="#" id="usa" class="btn btn-primary">United States</a>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<div id="container"></div>
		</div>
	</div>
	<script>
	function Zoom(args) {
		$.extend(this, {
			$buttons:   $(".zoom-button"),
			$info:      $("#zoom-info"),
			scale:      { max: 50, currentShift: 0 },
			$container: args.$container,
			datamap:    args.datamap
		});

		this.init();
	}

	Zoom.prototype.init = function() {
		var paths = this.datamap.svg.selectAll("path"),
		subunits = this.datamap.svg.selectAll(".datamaps-subunit");

  		// preserve stroke thickness
  		paths.style("vector-effect", "non-scaling-stroke");

  		// disable click on drag end
	  	subunits.call(
	  		d3.behavior.drag().on("dragend", function() {
  				d3.event.sourceEvent.stopPropagation();
  			})
  		);

	  	this.scale.set = this._getScalesArray();
  		this.d3Zoom = d3.behavior.zoom().scaleExtent([ 1, this.scale.max ]);

	 	this._displayPercentage(1);
  		this.listen();
	};

	Zoom.prototype.listen = function() {
		this.$buttons.off("click").on("click", this._handleClick.bind(this));

		this.datamap.svg
		.call(this.d3Zoom.on("zoom", this._handleScroll.bind(this)))
    	.on("dblclick.zoom", null); // disable zoom on double-click
	};

	Zoom.prototype.reset = function() {
		this._shift("reset");
	};

	Zoom.prototype._handleScroll = function() {
		var translate = d3.event.translate,
		scale = d3.event.scale,
		limited = this._bound(translate, scale);

		this.scrolled = true;

		this._update(limited.translate, limited.scale);
	};

	Zoom.prototype._handleClick = function(event) {
		var direction = $(event.target).data("zoom");

		this._shift(direction);
	};

	Zoom.prototype._shift = function(direction) {
		var center = [ this.$container.width() / 2, this.$container.height() / 2 ],
		translate = this.d3Zoom.translate(), translate0 = [], l = [],
		view = {
			x: translate[0],
			y: translate[1],
			k: this.d3Zoom.scale()
		}, bounded;

		translate0 = [
		(center[0] - view.x) / view.k,
		(center[1] - view.y) / view.k
		];

		if (direction == "reset") {
			view.k = 1;
			this.scrolled = true;
		} else {
			view.k = this._getNextScale(direction);
		}

		l = [ translate0[0] * view.k + view.x, translate0[1] * view.k + view.y ];

		view.x += center[0] - l[0];
		view.y += center[1] - l[1];

		bounded = this._bound([ view.x, view.y ], view.k);

		this._animate(bounded.translate, bounded.scale);
	};

	Zoom.prototype._bound = function(translate, scale) {
		var width = this.$container.width(),
		height = this.$container.height();

		translate[0] = Math.min(
			(width / height)  * (scale - 1),
			Math.max( width * (1 - scale), translate[0] )
			);

		translate[1] = Math.min(0, Math.max(height * (1 - scale), translate[1]));

		return { translate: translate, scale: scale };
	};

	Zoom.prototype._update = function(translate, scale) {
		this.d3Zoom
		.translate(translate)
		.scale(scale);

		this.datamap.svg.selectAll("g")
		.attr("transform", "translate(" + translate + ")scale(" + scale + ")");

		this._displayPercentage(scale);
	};

	Zoom.prototype._animate = function(translate, scale) {
		var _this = this,
		d3Zoom = this.d3Zoom;

		d3.transition().duration(350).tween("zoom", function() {
			var iTranslate = d3.interpolate(d3Zoom.translate(), translate),
			iScale = d3.interpolate(d3Zoom.scale(), scale);

			return function(t) {
				_this._update(iTranslate(t), iScale(t));
			};
		});
	};

	Zoom.prototype._displayPercentage = function(scale) {
		var value;

		value = Math.round(Math.log(scale) / Math.log(this.scale.max) * 100);
		this.$info.text(value + "%");
	};

	Zoom.prototype._getScalesArray = function() {
		var array = [],
		scaleMaxLog = Math.log(this.scale.max);

		for (var i = 0; i <= 10; i++) {
			array.push(Math.pow(Math.E, 0.1 * i * scaleMaxLog));
		}

		return array;
	};

	Zoom.prototype._getNextScale = function(direction) {
		var scaleSet = this.scale.set,
		currentScale = this.d3Zoom.scale(),
		lastShift = scaleSet.length - 1,
		shift, temp = [];

		if (this.scrolled) {

			for (shift = 0; shift <= lastShift; shift++) {
				temp.push(Math.abs(scaleSet[shift] - currentScale));
			}

			shift = temp.indexOf(Math.min.apply(null, temp));

			if (currentScale >= scaleSet[shift] && shift < lastShift) {
				shift++;
			}

			if (direction == "out" && shift > 0) {
				shift--;
			}

			this.scrolled = false;

		} else {

			shift = this.scale.currentShift;

			if (direction == "out") {
				shift > 0 && shift--;
			} else {
				shift < lastShift && shift++;
			}
		}

		this.scale.currentShift = shift;

		return scaleSet[shift];
	};
var data_map;
function Datamap(scope) {
	this.$container = $("#container");
	if (scope == 'world') {
		this.instance = new Datamaps({
			scope: 'world',
			element: this.$container.get(0),
			projection: 'mercator',
			geographyConfig: {
				highlightOnHover: false,
				popupOnHover: false
			},
			fills: {
				'RED': '#127073',
				'ORANGE': '#123456',
				defaultFill: '#95A863'
			},
			done: this._handleMapReady.bind(this)
		});
	}
	if (scope == 'usa') {
		this.instance = new Datamaps({
			scope: 'usa',
			element: this.$container.get(0),
			projection: 'mercator',
			geographyConfig: {
				highlightOnHover: false,
				popupOnHover: false
			},
			fills: {
				'RED': '#127073',
				'ORANGE': '#123456',
				defaultFill: '#95A863'
			},
			// setProjection: function(element) {
			// 	var projection = d3.geo.equirectangular()
			// 	.center([-85, 25])
			// 	.rotate([4.4, 0])
			// 	.scale(400)
			// 	.translate([element.offsetWidth / 2, element.offsetHeight / 2]);
			// 	var path = d3.geo.path()
			// 	.projection(projection);

			// 	return {path: path, projection: projection};
			// },
			done: this._handleMapReady.bind(this)
		});
	}
}

$('#nam').on('click', function() {
	// $("#container").parent().append("<div id='container' />");
	// $("#container").remove();
	$.getJSON('/sources/nam.json', function(json) {
		data_map.instance.bubbles(json);
	});
});

$('#gfs').on('click', function() {
	$.getJSON('/sources/gfs.json', function(json) {
		data_map.instance.bubbles(json);
	});
});

$('#usa').on('click', function() {
	$("#container").parent().append("<div id='container' />");
	$("#container").remove();
	data_map = new Datamap('usa');
});

$('#world').on('click', function() {
	$("#container").parent().append("<div id='container' />");
	$("#container").remove();
	data_map = new Datamap('world');
});

Datamap.prototype._handleMapReady = function(datamap) {
	this.zoom = new Zoom({
		$container: this.$container,
		datamap: datamap
	});
}

data_map = new Datamap('world');





		// var map = new Datamap({
		// 	element: document.getElementById('container'),
		// 	geographyConfig: {
  //           	highlightOnHover: false,
  //           	popupOnHover: false
  //       	},
		// 	responsive: true,
		// 	fills: {
		// 		'RED': '#127073',
		// 		'ORANGE': '#123456',
		// 		defaultFill: '#95A863'
		// 	}
		// });

		

		var cache_len = new Date(new Date().getTime() - 30000).getTime();

var spc_base_url = "http://www.spc.noaa.gov/exper/soundings/";
var spc_text = "";
var spc_time = null;

function createCORSRequest(method, url) {
	var xhr = new XMLHttpRequest();
	if ("withCredentials" in xhr) {
		xhr.open(method, url, true);
	}
	else if (typeof XDomainRequest != "undefined") {
		xhr = new XDomainRequest();
		xhr.open(method, url);
	}
	else {
		xhr = null;
	}
	return xhr;
}

function _download_spc() {
	var now = new Date().getTime();
	if (spc_time == null || spc_time < now - cache_len) {
		var xhr = createCORSRequest('GET', spc_base_url);
		xhr.setRequestHeader(
			'Access-Control-Allow-Origin', 'http://localhost:8080'
		);
		console.log(xhr);
		if (!xhr) {
			console.log('CORS not supported');
			return;
		}
		xhr.onload = function() {
			var text = xhr.responseText;
			console.log(text);
		}
		xhr.onerror = function() {
			console.log('There was an error making the request.');
		};
		xhr.send();

		spc_time = new Date().getTime();
	}
}
	</script>
<!-- <body ng-controller="mainController">
	<div class="container">
		
		<div id="todo-list" class="row">
			<div class="col-sm-4 col-sm-offset-4">
				<div class="checkbox" ng-repeat="todo in todos">
					<label>
						<input type="checkbox" ng-click="deleteTodo(todo._id)"> {{ todo.text }}
					</label>
				</div>
			</div>
		</div>

		<div id="todo-form" class="row">
			<div class="col-sm-8 col-sm-offset-2 text-center">
				<form>
					<div class="form-group">
						<input type="text" class="form-control input-lg text-center" placeholder="I want to buy a puppy that will love me forever" ng-model="formData.text">
					</div>
					<button type="submit" class="btn btn-primary btn-lg" ng-click="createTodo()">Add</button>
				</form>
			</div>
		</div>

	</div>
</body> -->
</html>